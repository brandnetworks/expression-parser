function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}();!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.ExpressionParser={})}(this,function(e){"use strict";function t(e){return"undefined"!=typeof e}function r(e){return"string"==typeof e}function i(e){return"boolean"==typeof e}function n(e){return"number"==typeof e}function s(e){return"[object Date]"===toString.call(e)}function o(e){return"function"==typeof e}function a(e){return"[object RegExp]"===toString.call(e)}function u(e){if(f(e))return e.map(u);if(s(e))return new Date(e.getTime());if(a(e)){var t=new RegExp(e.source,e.toString().match(/[^\/]*$/)[0]);return t.lastIndex=e.lastIndex,t}if(n(e)||r(e)||i(e)||o(e))return e;var t={};for(var h in e)e.hasOwnProperty(h)&&(t[h]=u(e[h]));return t}function h(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return Object.keys(t).forEach(function(r){"undefined"==typeof e[r]&&(e[r]=u(t[r]))}),e}var p,l={"+":!0,"-":!0,"*":!0,"/":!0,"%":!0,"==":!0,"!=":!0,"<":!0,">":!0,"<=":!0,">=":!0,"&&":!0,"||":!0,"!":!0,"=":!0,"|":!0},c={n:"\n",f:"\f",r:"\r",t:"	",v:"","'":"'",'"':'"'},f=(Object.getPrototypeOf,Array.isArray),x=function(){function e(t){_classCallCheck(this,e),this.options=t}return _createClass(e,[{key:"lex",value:function(e){for(this.text=e,this.index=0,this.tokens=[];this.index<this.text.length;){var t=this.text.charAt(this.index);if('"'===t||"'"===t)this.readString(t);else if(this.isNumber(t)||"."===t&&this.isNumber(this.peek()))this.readNumber();else if(this.isIdent(t))this.readIdent();else if(this.is(t,"(){}[].,;:?"))this.tokens.push({index:this.index,text:t}),this.index++;else if(this.isWhitespace(t))this.index++;else{var r=t+this.peek(),i=r+this.peek(2),n=l[t],s=l[r],o=l[i];if(n||s||o){var a=o?i:s?r:t;this.tokens.push({index:this.index,text:a,operator:!0}),this.index+=a.length}else this.throwError("Unexpected next character",this.index,this.index+1)}}return this.tokens}},{key:"is",value:function(e,t){return-1!==t.indexOf(e)}},{key:"peek",value:function(e){var t=e||1;return this.index+t<this.text.length?this.text.charAt(this.index+t):!1}},{key:"isNumber",value:function(e){return e>="0"&&"9">=e&&"string"==typeof e}},{key:"isWhitespace",value:function(e){return" "===e||"\r"===e||"	"===e||"\n"===e||""===e||"Â "===e}},{key:"isIdent",value:function(e){return e>="a"&&"z">=e||e>="A"&&"Z">=e||"_"===e||"$"===e}},{key:"isExpOperator",value:function(e){return"-"===e||"+"===e||this.isNumber(e)}},{key:"throwError",value:function(e,r,i){i=i||this.index;var n=t(r)?"s "+r+"-"+this.index+" ["+this.text.substring(r,i)+"]":" "+i;throw Error("Lexer Error: "+e+" at column"+n+" in expression ["+this.text+"].")}},{key:"readNumber",value:function(){for(var e="",t=this.index;this.index<this.text.length;){var r=this.text.charAt(this.index).toLowerCase();if("."===r||this.isNumber(r))e+=r;else{var i=this.peek();if("e"===r&&this.isExpOperator(i))e+=r;else if(this.isExpOperator(r)&&i&&this.isNumber(i)&&"e"===e.charAt(e.length-1))e+=r;else{if(!this.isExpOperator(r)||i&&this.isNumber(i)||"e"!==e.charAt(e.length-1))break;this.throwError("Invalid exponent")}}this.index++}this.tokens.push({index:t,text:e,constant:!0,value:Number(e)})}},{key:"readIdent",value:function(){for(var e=this.index;this.index<this.text.length;){var t=this.text.charAt(this.index);if(!this.isIdent(t)&&!this.isNumber(t))break;this.index++}this.tokens.push({index:e,text:this.text.slice(e,this.index),identifier:!0})}},{key:"readString",value:function(e){var t=this.index;this.index++;for(var r="",i=e,n=!1;this.index<this.text.length;){var s=this.text.charAt(this.index);if(i+=s,n){if("u"===s){var o=this.text.substring(this.index+1,this.index+5);o.match(/[\da-f]{4}/i)||this.throwError("Invalid unicode escape [\\u"+o+"]"),this.index+=4,r+=String.fromCharCode(parseInt(o,16))}else{var a=c[s];r+=a||s}n=!1}else if("\\"===s)n=!0;else{if(s===e)return this.index++,void this.tokens.push({index:t,text:i,constant:!0,value:r});r+=s}this.index++}this.throwError("Unterminated quote",t)}}]),e}();e.Lexer=x;var d={},y=function(){function e(t,r){_classCallCheck(this,e),this.lexer=t,this.options=h(r,d),this.constants={"true":{type:e.Literal,value:!0},"false":{type:e.Literal,value:!1},"null":{type:e.Literal,value:null},undefined:{type:e.Literal,value:void 0}}}return _createClass(e,[{key:"ast",value:function(e){this.text=e,this.tokens=this.lexer.lex(e);var t=this.filterChain();return this.peek(";")&&this.expect(";"),0!==this.tokens.length&&this.throwError("is an unexpected token",this.tokens[0]),t}},{key:"filterChain",value:function(){for(var e=this.expression(),t=void 0;t=this.expect("|");)e=this.filter(e);return e}},{key:"expression",value:function(){return this.ternary()}},{key:"ternary",value:function(){var t=this.logicalOR(),r=void 0,i=void 0;return this.expect("?")&&(i=this.expression(),this.consume(":"))?(r=this.expression(),{type:e.ConditionalExpression,test:t,consequent:i,alternate:r}):t}},{key:"logicalOR",value:function(){for(var t=this.logicalAND();this.expect("||");)t={type:e.LogicalExpression,operator:"||",left:t,right:this.logicalAND()};return t}},{key:"logicalAND",value:function(){for(var t=this.equality();this.expect("&&");)t={type:e.LogicalExpression,operator:"&&",left:t,right:this.equality()};return t}},{key:"equality",value:function(){for(var t=this.relational(),r=void 0;r=this.expect("==","!=");)t={type:e.BinaryExpression,operator:r.text,left:t,right:this.relational()};return t}},{key:"relational",value:function(){for(var t=this.additive(),r=void 0;r=this.expect("<",">","<=",">=");)t={type:e.BinaryExpression,operator:r.text,left:t,right:this.additive()};return t}},{key:"additive",value:function(){for(var t=this.multiplicative(),r=void 0;r=this.expect("+","-");)t={type:e.BinaryExpression,operator:r.text,left:t,right:this.multiplicative()};return t}},{key:"multiplicative",value:function(){for(var t=this.unary(),r=void 0;r=this.expect("*","/","%");)t={type:e.BinaryExpression,operator:r.text,left:t,right:this.unary()};return t}},{key:"unary",value:function(){var t=void 0;return(t=this.expect("+","-","!"))?{type:e.UnaryExpression,operator:t.text,prefix:!0,argument:this.unary()}:this.primary()}},{key:"primary",value:function t(){var t=void 0;this.expect("(")?(t=this.filterChain(),this.consume(")")):this.expect("[")?t=this.arrayDeclaration():this.expect("{")?t=this.object():this.constants.hasOwnProperty(this.peek().text)?t=u(this.constants[this.consume().text]):this.peek().identifier?t=this.identifier():this.peek().constant?t=this.constant():this.throwError("not a primary expression",this.peek());for(var r=void 0;r=this.expect("(","[",".");)"["===r.text?(t={type:e.MemberExpression,object:t,property:this.expression(),computed:!0},this.consume("]")):"."===r.text?t={type:e.MemberExpression,object:t,property:this.identifier(),computed:!1}:this.throwError("IMPOSSIBLE");return t}},{key:"filter",value:function(t){for(var r=[t],i={type:e.CallExpression,callee:this.identifier(),arguments:r,filter:!0};this.expect(":");)r.push(this.expression());return i}},{key:"identifier",value:function(){var t=this.consume();return t.identifier||this.throwError("is not a valid identifier",t),{type:e.Identifier,name:t.text}}},{key:"constant",value:function(){return{type:e.Literal,value:this.consume().value}}},{key:"arrayDeclaration",value:function(){var t=[];if("]"!==this.peekToken().text)do{if(this.peek("]"))break;t.push(this.expression())}while(this.expect(","));return this.consume("]"),{type:e.ArrayExpression,elements:t}}},{key:"object",value:function(){var t=[],r=void 0;if("}"!==this.peekToken().text)do{if(this.peek("}"))break;r={type:e.Property,kind:"init"},this.peek().constant?r.key=this.constant():this.peek().identifier?r.key=this.identifier():this.throwError("invalid key",this.peek()),this.consume(":"),r.value=this.expression(),t.push(r)}while(this.expect(","));return this.consume("}"),{type:e.ObjectExpression,properties:t}}},{key:"throwError",value:function(e,t){throw Error("Syntax Error: Token '"+t.text+"' "+e+" at column "+(t.index+1)+" of the expression ["+this.text+"] starting at ["+this.text.substring(t.index)+"].")}},{key:"consume",value:function(e){if(0===this.tokens.length)throw Error("Unexpected end of expression: "+this.text);var t=this.expect(e);return t||this.throwError("is unexpected, expecting ["+e+"]",this.peek()),t}},{key:"peekToken",value:function(){if(0===this.tokens.length)throw Error("Unexpected end of expression: "+this.text);return this.tokens[0]}},{key:"peek",value:function(e,t,r,i){return this.peekAhead(0,e,t,r,i)}},{key:"peekAhead",value:function(e,t,r,i,n){if(this.tokens.length>e){var s=this.tokens[e],o=s.text;if(o===t||o===r||o===i||o===n||!t&&!r&&!i&&!n)return s}return!1}},{key:"expect",value:function(e,t,r,i){var n=this.peek(e,t,r,i);return n?(this.tokens.shift(),n):!1}}]),e}();y.ConditionalExpression="ConditionalExpression",y.LogicalExpression="LogicalExpression",y.BinaryExpression="BinaryExpression",y.UnaryExpression="UnaryExpression",y.CallExpression="CallExpression",y.MemberExpression="MemberExpression",y.Identifier="Identifier",y.Literal="Literal",y.ArrayExpression="ArrayExpression",y.Property="Property",y.ObjectExpression="ObjectExpression",y.PRECEDENCE=(p={},_defineProperty(p,y.ConditionalExpression,1),_defineProperty(p,y.LogicalExpression,1),_defineProperty(p,y.BinaryExpression,2),_defineProperty(p,y.UnaryExpression,3),_defineProperty(p,y.CallExpression,4),_defineProperty(p,y.MemberExpression,5),_defineProperty(p,y.Identifier,6),_defineProperty(p,y.Literal,6),_defineProperty(p,y.ObjectExpression,6),_defineProperty(p,y.Property,6),_defineProperty(p,y.ArrayExpression,6),p),y.LOGICAL_EXPRESSION_PRECEDENCE={"||":1,"&&":2},y.BINARY_EXPRESSION_PRECEDENCE={"==":1,"!=":1,"<":2,"<=":2,">":2,">=":2,"+":3,"-":3,"*":4,"/":4,"%":4},e.AST=y;var v={LexerClass:x,ASTBuilderClass:y},E=function(){function e(t){_classCallCheck(this,e),this.options=h(t,v);var r=new this.options.LexerClass;this.astBuilder=new this.options.ASTBuilderClass(r)}return _createClass(e,[{key:"precedence",value:function(e,t){var r=y.PRECEDENCE;if(r[e.type]<r[t.type])return-1;if(r[e.type]>r[t.type])return 1;if(e.type===y.LogicalExpression||e.type===y.BinaryExpression){var i=e.type===y.LogicalExpression?y.LOGICAL_EXPRESSION_PRECEDENCE:y.BINARY_EXPRESSION_PRECEDENCE;if(i[e.operator]<i[t.operator])return-1;if(i[e.operator]>i[t.operator])return 1}return 0}},{key:"toString",value:function(e,t){var r=this,i=function(t){return r.toString(t,e)};if(t&&this.precedence(e,t)<0)return"("+this.toString(e)+")";switch(e.type){case y.ConditionalExpression:return i(e.test)+" ? "+i(e.consequent)+" : "+i(e.alternate);case y.LogicalExpression:return i(e.left)+" "+e.operator+" "+i(e.right);case y.BinaryExpression:return i(e.left)+" "+e.operator+" "+i(e.right);case y.UnaryExpression:return""+e.operator+i(e.argument);case y.CallExpression:var n=e.arguments.slice(1).map(function(e){return e.type===y.CallExpression?":("+i(e)+")":":"+i(e)}).join("");return i(e.arguments[0])+"|"+e.callee.name+n;case y.MemberExpression:return e.computed||e.property.type!==y.Identifier?i(e.object)+"["+i(e.property)+"]":i(e.object)+"."+e.property.name;case y.Identifier:return e.name;case y.Literal:return void 0===e.value?"undefined":JSON.stringify(e.value);case y.ArrayExpression:return"["+e.elements.map(function(e){return r.toString(e)}).join(", ")+"]";case y.ObjectExpression:var s=e.properties.map(function(e){return e.key.type===y.Identifier||e.key.type===y.Literal?r.toString(e.key)+": "+r.toString(e.value):void r.throwError("IMPOSSIBLE")});return"{"+s.join(", ")+"}"}}},{key:"eval",value:function(e){var t=this,r=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],i=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],n=function(e){return t.eval(e,r,i)};try{switch(e.type){case y.ConditionalExpression:return n(n(e.test)?e.consequent:e.alternate);case y.LogicalExpression:switch(e.operator){case"&&":return n(e.left)&&n(e.right);case"||":return n(e.left)||n(e.right);default:this.throwError("IMPOSSIBLE")}break;case y.BinaryExpression:var s=n(e.left),o=n(e.right);switch(e.operator){case"==":return s===o;case"!=":return s!==o;case"<":return o>s;case"<=":return o>=s;case">":return s>o;case">=":return s>=o;case"+":return s+o;case"-":return s-o;case"*":return s*o;case"/":return s/o;case"%":return s%o;default:this.throwError("IMPOSSIBLE")}break;case y.UnaryExpression:switch(e.operator){case"+":return+n(e.argument);case"-":return-n(e.argument);case"!":return!n(e.argument);default:this.throwError("IMPOSSIBLE")}break;case y.CallExpression:e.callee.type!==y.Identifier&&this.throwError("IMPOSSIBLE"),e.callee.name in i||this.throwError("Reference error: ["+e.callee.name+"] is not a defined filter");var a=i[e.callee.name],u=e.arguments.map(n);return a.apply(null,u);case y.MemberExpression:return e.property.type!==y.Identifier||e.computed?n(e.object)[n(e.property)]:n(e.object)[e.property.name];case y.Identifier:return e.name in r||this.throwError("Reference error: ["+e.name+"] is not a defined variable"),r[e.name];case y.Literal:return e.value;case y.ArrayExpression:return e.elements.map(n);case y.ObjectExpression:var h={};return e.properties.forEach(function(e){e.key.type===y.Identifier?h[e.key.name]=n(e.value):h[n(e.key)]=n(e.value)}),h}}catch(p){if(p.bubble)throw p;var l=p.message||"No info available";this.throwError("There was an error evaluating `"+this.toString(e)+"` ("+l+")",!0)}}},{key:"throwError",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?!1:arguments[1],r=Error("Parse Error: "+e);throw r.bubble=t,r}},{key:"parse",value:function(e){var t=this,r=this.astBuilder.ast(e);return function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],i=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return t.eval(r,e,i)}}}]),e}();e.Parser=E});
//# sourceMappingURL=expression-parser.min.js.map