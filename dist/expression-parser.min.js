function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}();!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("defaults")):"function"==typeof define&&define.amd?define(["exports","defaults"],t):t(e.MyLibrary={},e.defaults)}(this,function(e,t){"use strict";function r(e){return"undefined"!=typeof e}function i(e){return"[object Date]"===toString.call(e)}function n(e){return"[object RegExp]"===toString.call(e)}function s(e){if(u(e))return e.map(s);if(i(e))return new Date(e.getTime());if(n(e)){var t=new RegExp(e.source,e.toString().match(/[^\/]*$/)[0]);return t.lastIndex=e.lastIndex,t}var t={};for(var r in e)e.hasOwnProperty(r)&&(t[r]=s(e[r]));return t}function a(e){for(var t=!0;t;){var r=e;if(t=!1,r.type===c.Identifier)return!0;if(r.type!==c.MemberExpression)return!1;e=r.object,t=!0}}t="default"in t?t["default"]:t;var o={"+":!0,"-":!0,"*":!0,"/":!0,"%":!0,"===":!0,"!==":!0,"==":!0,"!=":!0,"<":!0,">":!0,"<=":!0,">=":!0,"&&":!0,"||":!0,"!":!0,"=":!0,"|":!0},h={n:"\n",f:"\f",r:"\r",t:"	",v:"","'":"'",'"':'"'},u=(Object.getPrototypeOf,Array.isArray),l=function(){function e(t){_classCallCheck(this,e),this.options=t}return _createClass(e,[{key:"lex",value:function(e){for(this.text=e,this.index=0,this.tokens=[];this.index<this.text.length;){var t=this.text.charAt(this.index);if('"'===t||"'"===t)this.readString(t);else if(this.isNumber(t)||"."===t&&this.isNumber(this.peek()))this.readNumber();else if(this.isIdent(t))this.readIdent();else if(this.is(t,"(){}[].,;:?"))this.tokens.push({index:this.index,text:t}),this.index++;else if(this.isWhitespace(t))this.index++;else{var r=t+this.peek(),i=r+this.peek(2),n=o[t],s=o[r],a=o[i];if(n||s||a){var h=a?i:s?r:t;this.tokens.push({index:this.index,text:h,operator:!0}),this.index+=h.length}else this.throwError("Unexpected next character",this.index,this.index+1)}}return this.tokens}},{key:"is",value:function(e,t){return-1!==t.indexOf(e)}},{key:"peek",value:function(e){var t=e||1;return this.index+t<this.text.length?this.text.charAt(this.index+t):!1}},{key:"isNumber",value:function(e){return e>="0"&&"9">=e&&"string"==typeof e}},{key:"isWhitespace",value:function(e){return" "===e||"\r"===e||"	"===e||"\n"===e||""===e||"Â "===e}},{key:"isIdent",value:function(e){return e>="a"&&"z">=e||e>="A"&&"Z">=e||"_"===e||"$"===e}},{key:"isExpOperator",value:function(e){return"-"===e||"+"===e||this.isNumber(e)}},{key:"throwError",value:function(e,t,i){i=i||this.index;var n=r(t)?"s "+t+"-"+this.index+" ["+this.text.substring(t,i)+"]":" "+i;throw Error("Lexer Error: "+e+" at column"+n+" in expression ["+this.text+"].")}},{key:"readNumber",value:function(){for(var e="",t=this.index;this.index<this.text.length;){var r=this.text.charAt(this.index).toLowerCase();if("."===r||this.isNumber(r))e+=r;else{var i=this.peek();if("e"===r&&this.isExpOperator(i))e+=r;else if(this.isExpOperator(r)&&i&&this.isNumber(i)&&"e"===e.charAt(e.length-1))e+=r;else{if(!this.isExpOperator(r)||i&&this.isNumber(i)||"e"!==e.charAt(e.length-1))break;this.throwError("Invalid exponent")}}this.index++}this.tokens.push({index:t,text:e,constant:!0,value:Number(e)})}},{key:"readIdent",value:function(){for(var e=this.index;this.index<this.text.length;){var t=this.text.charAt(this.index);if(!this.isIdent(t)&&!this.isNumber(t))break;this.index++}this.tokens.push({index:e,text:this.text.slice(e,this.index),identifier:!0})}},{key:"readString",value:function(e){var t=this.index;this.index++;for(var r="",i=e,n=!1;this.index<this.text.length;){var s=this.text.charAt(this.index);if(i+=s,n){if("u"===s){var a=this.text.substring(this.index+1,this.index+5);a.match(/[\da-f]{4}/i)||this.throwError("Invalid unicode escape [\\u"+a+"]"),this.index+=4,r+=String.fromCharCode(parseInt(a,16))}else{var o=h[s];r+=o||s}n=!1}else if("\\"===s)n=!0;else{if(s===e)return this.index++,void this.tokens.push({index:t,text:i,constant:!0,value:r});r+=s}this.index++}this.throwError("Unterminated quote",t)}}]),e}();e.Lexer=l;var p={allowAssignments:!0,multipleExpressions:!0},c=function(){function e(r,i){_classCallCheck(this,e),this.lexer=r,this.options=t(i,p),this.constants={"true":{type:e.Literal,value:!0},"false":{type:e.Literal,value:!1},"null":{type:e.Literal,value:null},undefined:{type:e.Literal,value:void 0}}}return _createClass(e,[{key:"ast",value:function(e){this.text=e,this.tokens=this.lexer.lex(e);var t=this.options.multipleExpressions?this.program():this.expressionStatement();return 0!==this.tokens.length&&this.throwError("is an unexpected token",this.tokens[0]),t}},{key:"program",value:function(){for(var t=[];;)if(this.tokens.length>0&&!this.peek("}",")",";","]")&&t.push(this.expressionStatement()),!this.expect(";"))return{type:e.Program,body:t}}},{key:"expressionStatement",value:function(){return{type:e.ExpressionStatement,expression:this.filterChain()}}},{key:"filterChain",value:function(){for(var e=this.expression(),t=void 0;t=this.expect("|");)e=this.filter(e);return e}},{key:"expression",value:function(){return this.assignment()}},{key:"assignment",value:function(){var t=this.ternary();return this.options.allowAssignments&&this.expect("=")&&(t={type:e.AssignmentExpression,left:t,right:this.assignment(),operator:"="}),t}},{key:"ternary",value:function(){var t=this.logicalOR(),r=void 0,i=void 0;return this.expect("?")&&(i=this.expression(),this.consume(":"))?(r=this.expression(),{type:e.ConditionalExpression,test:t,consequent:i,alternate:r}):t}},{key:"logicalOR",value:function(){for(var t=this.logicalAND();this.expect("||");)t={type:e.LogicalExpression,operator:"||",left:t,right:this.logicalAND()};return t}},{key:"logicalAND",value:function(){for(var t=this.equality();this.expect("&&");)t={type:e.LogicalExpression,operator:"&&",left:t,right:this.equality()};return t}},{key:"equality",value:function(){for(var t=this.relational(),r=void 0;r=this.expect("==","!=","===","!==");)t={type:e.BinaryExpression,operator:r.text,left:t,right:this.relational()};return t}},{key:"relational",value:function(){for(var t=this.additive(),r=void 0;r=this.expect("<",">","<=",">=");)t={type:e.BinaryExpression,operator:r.text,left:t,right:this.additive()};return t}},{key:"additive",value:function(){for(var t=this.multiplicative(),r=void 0;r=this.expect("+","-");)t={type:e.BinaryExpression,operator:r.text,left:t,right:this.multiplicative()};return t}},{key:"multiplicative",value:function(){for(var t=this.unary(),r=void 0;r=this.expect("*","/","%");)t={type:e.BinaryExpression,operator:r.text,left:t,right:this.unary()};return t}},{key:"unary",value:function(){var t=void 0;return(t=this.expect("+","-","!"))?{type:e.UnaryExpression,operator:t.text,prefix:!0,argument:this.unary()}:this.primary()}},{key:"primary",value:function r(){var r=void 0;this.expect("(")?(r=this.filterChain(),this.consume(")")):this.expect("[")?r=this.arrayDeclaration():this.expect("{")?r=this.object():this.constants.hasOwnProperty(this.peek().text)?r=s(this.constants[this.consume().text]):this.peek().identifier?r=this.identifier():this.peek().constant?r=this.constant():this.throwError("not a primary expression",this.peek());for(var t=void 0;t=this.expect("(","[",".");)"("===t.text?(r={type:e.CallExpression,callee:r,arguments:this.parseArguments()},this.consume(")")):"["===t.text?(r={type:e.MemberExpression,object:r,property:this.expression(),computed:!0},this.consume("]")):"."===t.text?r={type:e.MemberExpression,object:r,property:this.identifier(),computed:!1}:this.throwError("IMPOSSIBLE");return r}},{key:"filter",value:function(t){for(var r=[t],i={type:e.CallExpression,callee:this.identifier(),arguments:r,filter:!0};this.expect(":");)r.push(this.expression());return i}},{key:"parseArguments",value:function(){var e=[];if(")"!==this.peekToken().text)do e.push(this.expression());while(this.expect(","));return e}},{key:"identifier",value:function(){var t=this.consume();return t.identifier||this.throwError("is not a valid identifier",t),{type:e.Identifier,name:t.text}}},{key:"constant",value:function(){return{type:e.Literal,value:this.consume().value}}},{key:"arrayDeclaration",value:function(){var t=[];if("]"!==this.peekToken().text)do{if(this.peek("]"))break;t.push(this.expression())}while(this.expect(","));return this.consume("]"),{type:e.ArrayExpression,elements:t}}},{key:"object",value:function(){var t=[],r=void 0;if("}"!==this.peekToken().text)do{if(this.peek("}"))break;r={type:e.Property,kind:"init"},this.peek().constant?r.key=this.constant():this.peek().identifier?r.key=this.identifier():this.throwError("invalid key",this.peek()),this.consume(":"),r.value=this.expression(),t.push(r)}while(this.expect(","));return this.consume("}"),{type:e.ObjectExpression,properties:t}}},{key:"throwError",value:function(e,t){throw Error("Syntax Error: Token '"+t.text+"' "+e+" at column "+(t.index+1)+" of the expression ["+this.text+"] starting at ["+this.text.substring(t.index)+"].")}},{key:"consume",value:function(e){if(0===this.tokens.length)throw Error("Unexpected end of expression: "+this.text);var t=this.expect(e);return t||this.throwError("is unexpected, expecting ["+e+"]",this.peek()),t}},{key:"peekToken",value:function(){if(0===this.tokens.length)throw Error("Unexpected end of expression: "+this.text);return this.tokens[0]}},{key:"peek",value:function(e,t,r,i){return this.peekAhead(0,e,t,r,i)}},{key:"peekAhead",value:function(e,t,r,i,n){if(this.tokens.length>e){var s=this.tokens[e],a=s.text;if(a===t||a===r||a===i||a===n||!t&&!r&&!i&&!n)return s}return!1}},{key:"expect",value:function(e,t,r,i){var n=this.peek(e,t,r,i);return n?(this.tokens.shift(),n):!1}}]),e}();c.Program="Program",c.ExpressionStatement="ExpressionStatement",c.AssignmentExpression="AssignmentExpression",c.ConditionalExpression="ConditionalExpression",c.LogicalExpression="LogicalExpression",c.BinaryExpression="BinaryExpression",c.UnaryExpression="UnaryExpression",c.CallExpression="CallExpression",c.MemberExpression="MemberExpression",c.Identifier="Identifier",c.Literal="Literal",c.ArrayExpression="ArrayExpression",c.Property="Property",c.ObjectExpression="ObjectExpression",e.AST=c;var x=function(){function e(t,r){_classCallCheck(this,e),this.astBuilder=t}return _createClass(e,[{key:"eval",value:function(e,t){var r=this,i=function(e){return r.eval(e,t)};switch(e.type){case c.Program:var n=void 0,s=!0,o=!1,h=void 0;try{for(var u,l=e.body[Symbol.iterator]();!(s=(u=l.next()).done);s=!0){var p=u.value;n=i(p)}}catch(x){o=!0,h=x}finally{try{!s&&l["return"]&&l["return"]()}finally{if(o)throw h}}return n;case c.ExpressionStatement:return i(e.expression);case c.ConditionalExpression:return i(i(e.test)?e.consequent:e.alternate);case c.LogicalExpression:switch(e.operator){case"&&":return i(e.left)&&i(e.right);case"||":return i(e.left)||i(e.right);default:throw Error()}break;case c.BinaryExpression:var f=i(e.left),d=i(e.right);switch(e.operator){case"==":case"===":return f===d;case"!=":case"!==":return f!==d;case"<":return d>f;case"<=":return d>=f;case">":return f>d;case">=":return f>=d;case"+":return f+d;case"-":return f-d;case"*":return f*d;case"/":return f/d;case"%":return f%d;default:throw Error()}break;case c.UnaryExpression:switch(e.operator){case"+":return+i(e.argument);case"-":return-i(e.argument);case"!":return!i(e.argument);default:throw Error()}break;case c.CallExpression:var v=i(e.callee),y=e.arguments.map(i);return v.apply(null,y);case c.MemberExpression:return e.property.type!==c.Identifier||e.computed?i(e.object)[i(e.property)]:i(e.object)[e.property.name];case c.Identifier:if(!(e.name in t))throw Error("Reference error: "+e.name+" is not defined");return t[e.name];case c.Literal:return e.value;case c.ArrayExpression:return e.elements.map(i);case c.ObjectExpression:var k={};return e.properties.forEach(function(e){k[i(e.key)]=i(e.value)}),k;case c.AssignmentExpression:if(!a(e.left))throw Error("Trying to assign a value to a non l-value");return void(t[i(e.left)]=i(e.right))}}},{key:"parse",value:function(e){var t=this,r=this.astBuilder.ast(e);return function(e){return t.eval(r,e)}}}]),e}();e.Parser=x});
//# sourceMappingURL=expression-parser.min.js.map